<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¬ìš©ì ê´€ë¦¬ - Newsletter AI Processor</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Space+Grotesk:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        :root {
            --color-primary: #667eea;
            --color-secondary: #00d4ff;
            --color-accent: #f093fb;
            --color-success: #4facfe;
            --color-success-dark: #38f9d7;
            --color-danger: #f5576c;
            --color-warning: #fbbf24;
            --color-info: #667eea;

            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #16213e;
            --bg-card: rgba(255, 255, 255, 0.05);
            --bg-overlay: rgba(0, 0, 0, 0.2);

            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --text-muted: #cbd5e0;

            --border-primary: rgba(255, 255, 255, 0.08);
            --border-secondary: rgba(255, 255, 255, 0.12);
            --border-accent: rgba(0, 212, 255, 0.5);

            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;

            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --radius-full: 9999px;

            --shadow-sm: 0 2px 10px rgba(0, 0, 0, 0.2);
            --shadow-md: 0 4px 20px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.3);
            --shadow-glow: 0 0 20px rgba(102, 126, 234, 0.3);

            --transition-base: 0.3s ease;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>

<body>
    <div class="stars" id="stars"></div>
    <div class="container">
        <!-- Header and Navigation -->
        <div class="header">
            <div class="header-left">
                <h1 class="logo">Newsletter AI</h1>
                <div class="nav-links">
                    <a href="./dashboard" class="nav-link">ğŸ“Š ëŒ€ì‹œë³´ë“œ</a>
                    <a href="./newsletter-sources" class="nav-link">ğŸ“§ ë‰´ìŠ¤ë ˆí„° ì†ŒìŠ¤</a>
                    <a href="./contents" class="nav-link">ğŸ“ ì½˜í…ì¸ </a>
                    <a href="./keywords" class="nav-link">ğŸ”‘ í‚¤ì›Œë“œ</a>
                    <a href="./exposure-fix" class="nav-link">ğŸ”§ ë…¸ì¶œ ê´€ë¦¬</a>
                    <a href="./users" class="nav-link active">ğŸ‘¥ ì‚¬ìš©ì</a>
                    <a href="./rss-reader" class="nav-link">ğŸ“¡ RSS ë¦¬ë”</a>
                </div>
            </div>
        </div>

        <!-- Overall Statistics Dashboard -->
        <div class="section">
            <h2>ğŸ“Š ì „ì²´ í†µê³„</h2>
            <div class="row">
                <div class="col-md-4">
                    <div class="result-card">
                        <div class="result-title">ì „ì²´ ì‚¬ìš©ì</div>
                        <div style="font-size: 2.5rem; font-weight: 700; color: #667eea; margin-top: 1rem;">
                            <span id="total-users">-</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="result-card">
                        <div class="result-title">í™œì„± ì‚¬ìš©ì</div>
                        <div style="font-size: 2.5rem; font-weight: 700; color: #4facfe; margin-top: 1rem;">
                            <span id="active-users">-</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="result-card">
                        <div class="result-title">í™œì„± ë¹„ìœ¨</div>
                        <div style="font-size: 2.5rem; font-weight: 700; color: #f093fb; margin-top: 1rem;">
                            <span id="active-ratio">-</span>%
                        </div>
                    </div>
                </div>
            </div>

            <!-- Most Active Users -->
            <div style="margin-top: 2rem;">
                <h3>ğŸ† ê°€ì¥ í™œë™ì ì¸ ì‚¬ìš©ì (Top 10)</h3>
                <div id="most-active-users-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Trend Chart -->
        <div class="section">
            <h2>ğŸ“ˆ í™œë™ ì¶”ì´ (ìµœê·¼ 30ì¼)</h2>
            <div style="position: relative; height: 400px;">
                <canvas id="activity-trend-chart"></canvas>
            </div>
        </div>

        <!-- User Search and List -->
        <div class="section">
            <h2>ğŸ‘¥ ì‚¬ìš©ì ëª©ë¡</h2>

            <!-- Search Controls -->
            <div class="row" style="margin-bottom: 1.5rem;">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">ì‚¬ìš©ì IDë¡œ ê²€ìƒ‰</label>
                        <input type="text" id="search-user-id" class="form-control" placeholder="ì‚¬ìš©ì ID ì…ë ¥...">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">ë””ë°”ì´ìŠ¤ í† í°ìœ¼ë¡œ ê²€ìƒ‰</label>
                        <input type="text" id="search-device-token" class="form-control" placeholder="ë””ë°”ì´ìŠ¤ í† í° ì…ë ¥...">
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                <button id="search-btn" class="btn btn-primary">ğŸ” ê²€ìƒ‰</button>
                <button id="clear-search-btn" class="btn btn-secondary">âœ–ï¸ ì´ˆê¸°í™”</button>
            </div>

            <!-- User List -->
            <div id="user-list">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>

            <!-- Pagination -->
            <div class="pagination" id="user-pagination">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- User Detail Modal -->
    <div class="modal-overlay" id="user-detail-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">ì‚¬ìš©ì ìƒì„¸ ì •ë³´</h3>
                <button class="modal-close" onclick="closeUserDetailModal()">âœ•</button>
            </div>
            <div class="modal-body" id="user-detail-content">
                <!-- Will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeUserDetailModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Import shared components -->
    <script th:src="@{/js/utils/cache-manager.js}"></script>
    <script th:src="@{/js/utils/api-client.js}"></script>
    <script th:src="@{/js/components/toast.js}"></script>
    <script th:src="@{/js/components/modal.js}"></script>
    <script th:src="@{/js/components/content-card.js}"></script>
    <script th:src="@{/js/components/user-card.js}"></script>
    <script th:src="@{/js/components/activity-chart.js}"></script>

    <script>
        // Initialize stars background
        function createStars() {
            const starsContainer = document.getElementById('stars');
            const starCount = 100;

            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 2 + 's';
                starsContainer.appendChild(star);
            }
        }

        // State management
        let currentPage = 0;
        let totalPages = 0;
        let searchUserId = '';
        let searchDeviceToken = '';
        let activityChart = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function () {
            createStars();
            loadOverallStatistics();
            loadActivityTrend();
            loadUsers(0);
            setupEventListeners();
        });

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('search-btn').addEventListener('click', performSearch);
            document.getElementById('clear-search-btn').addEventListener('click', clearSearch);

            // Allow Enter key to trigger search
            document.getElementById('search-user-id').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') performSearch();
            });
            document.getElementById('search-device-token').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') performSearch();
            });
        }

        // Load overall statistics
        async function loadOverallStatistics() {
            try {
                // Cache statistics for 5 minutes (300000ms)
                const stats = await ApiClient.get('/api/users/statistics', {
                    cache: true,
                    cacheTTL: 5 * 60 * 1000
                });

                document.getElementById('total-users').textContent = stats.totalUsers || 0;
                document.getElementById('active-users').textContent = stats.activeUsers || 0;

                const ratio = stats.totalUsers > 0
                    ? ((stats.activeUsers / stats.totalUsers) * 100).toFixed(1)
                    : 0;
                document.getElementById('active-ratio').textContent = ratio;

                // Load most active users
                loadMostActiveUsers();
            } catch (error) {
                console.error('Failed to load statistics:', error);
                Toast.show('í†µê³„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // Load most active users
        async function loadMostActiveUsers() {
            try {
                // Cache most active users for 5 minutes
                const users = await ApiClient.get('/api/users/most-active?limit=10', {
                    cache: true,
                    cacheTTL: 5 * 60 * 1000
                });
                const container = document.getElementById('most-active-users-list');

                if (!users || users.length === 0) {
                    container.innerHTML = '<p class="text-muted text-center">í™œë™ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                container.innerHTML = users.map((user, index) => `
                    <div class="result-card" style="cursor: pointer;" onclick="showUserDetail(${user.userId})">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: ${index < 3 ? '#fbbf24' : '#94a3b8'};">
                                    #${index + 1}
                                </div>
                                <div>
                                    <div class="result-title" style="margin-bottom: 0;">ì‚¬ìš©ì ID: ${user.userId}</div>
                                    <div class="content-source">${user.deviceToken ? user.deviceToken.substring(0, 20) + '...' : 'N/A'}</div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #667eea;">
                                    ${user.archiveCount}
                                </div>
                                <div class="content-source">ì•„ì¹´ì´ë¸Œ</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load most active users:', error);
                document.getElementById('most-active-users-list').innerHTML =
                    '<p class="text-danger text-center">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
            }
        }

        // Load activity trend
        async function loadActivityTrend() {
            try {
                // Cache activity trend for 10 minutes
                const trendData = await ApiClient.get('/api/users/activity-trend?days=30', {
                    cache: true,
                    cacheTTL: 10 * 60 * 1000
                });

                if (!trendData || trendData.length === 0) {
                    document.getElementById('activity-trend-chart').parentElement.innerHTML =
                        '<p class="text-muted text-center">í™œë™ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                // Prepare chart data
                const labels = trendData.map(d => {
                    const date = new Date(d.date);
                    return `${date.getMonth() + 1}/${date.getDate()}`;
                });
                const data = trendData.map(d => d.count);

                // Create chart using ActivityChart component
                const ctx = document.getElementById('activity-trend-chart').getContext('2d');
                activityChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'ì¼ì¼ í™œì„± ì‚¬ìš©ì',
                            data: data,
                            borderColor: 'rgb(0, 212, 255)',
                            backgroundColor: 'rgba(0, 212, 255, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#ffffff'
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: '#a0aec0'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#a0aec0'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Failed to load activity trend:', error);
                Toast.show('í™œë™ ì¶”ì´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // Load users with pagination
        async function loadUsers(page) {
            try {
                const params = new URLSearchParams({
                    page: page,
                    size: 20
                });

                if (searchUserId) {
                    params.append('userId', searchUserId);
                }
                if (searchDeviceToken) {
                    params.append('deviceToken', searchDeviceToken);
                }

                // Cache user list for 2 minutes
                const response = await ApiClient.get(`/api/users?${params.toString()}`, {
                    cache: true,
                    cacheTTL: 2 * 60 * 1000
                });

                currentPage = response.number || 0;
                totalPages = response.totalPages || 0;

                renderUserList(response.content || []);
                renderPagination();
            } catch (error) {
                console.error('Failed to load users:', error);
                document.getElementById('user-list').innerHTML =
                    '<p class="text-danger text-center">ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
            }
        }

        // Render user list
        function renderUserList(users) {
            const container = document.getElementById('user-list');

            if (!users || users.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            // Clear container
            container.innerHTML = '';

            // Render each user card
            users.forEach(user => {
                const userCard = new UserCard(user, {
                    showDetails: true,
                    actions: [
                        {
                            text: 'ìƒì„¸ ë³´ê¸°',
                            onClick: () => showUserDetail(user.id),
                            className: 'btn-primary'
                        }
                    ]
                });
                container.appendChild(userCard.render());
            });
        }

        // Render pagination
        function renderPagination() {
            const container = document.getElementById('user-pagination');

            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '';

            // Previous button
            html += `<button class="pagination-item" ${currentPage === 0 ? 'disabled' : ''}
                     onclick="loadUsers(${currentPage - 1})">ì´ì „</button>`;

            // Page numbers
            const startPage = Math.max(0, currentPage - 2);
            const endPage = Math.min(totalPages - 1, currentPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="pagination-item ${i === currentPage ? 'active' : ''}"
                         onclick="loadUsers(${i})">${i + 1}</button>`;
            }

            // Next button
            html += `<button class="pagination-item" ${currentPage >= totalPages - 1 ? 'disabled' : ''}
                     onclick="loadUsers(${currentPage + 1})">ë‹¤ìŒ</button>`;

            container.innerHTML = html;
        }

        // Perform search
        function performSearch() {
            searchUserId = document.getElementById('search-user-id').value.trim();
            searchDeviceToken = document.getElementById('search-device-token').value.trim();
            loadUsers(0);
        }

        // Clear search
        function clearSearch() {
            searchUserId = '';
            searchDeviceToken = '';
            document.getElementById('search-user-id').value = '';
            document.getElementById('search-device-token').value = '';
            loadUsers(0);
        }

        // Show user detail modal
        async function showUserDetail(userId) {
            try {
                const modal = document.getElementById('user-detail-modal');
                const content = document.getElementById('user-detail-content');

                content.innerHTML = '<div class="loading"><div class="spinner"></div><p>ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>';
                modal.classList.add('active');

                // Load user details
                const user = await ApiClient.get(`/api/users/${userId}`);
                const stats = await ApiClient.get(`/api/users/${userId}/statistics`);
                const categories = await ApiClient.get(`/api/users/${userId}/categories`);
                const archives = await ApiClient.get(`/api/users/${userId}/archives?days=30`);

                // Render user detail
                content.innerHTML = `
                    <div class="result-card">
                        <h3 class="result-title">ê¸°ë³¸ ì •ë³´</h3>
                        <div style="margin-top: 1rem;" class="card-content">
                            <p><strong>ì‚¬ìš©ì ID:</strong> ${user.id}</p>
                            <p><strong>ë””ë°”ì´ìŠ¤ í† í°:</strong> ${user.deviceToken || 'N/A'}</p>
                            <p><strong>ìƒì„±ì¼:</strong> ${new Date(user.createdAt).toLocaleString('ko-KR')}</p>
                        </div>
                    </div>

                    <div class="result-card">
                        <h3 class="result-title">í™œë™ í†µê³„</h3>
                        <div style="margin-top: 1rem;" class="card-content">
                            <p><strong>ì´ í™œë™ ì¼ìˆ˜:</strong> ${stats.totalDaysActive || 0}ì¼</p>
                            <p><strong>ì—°ì† í™œë™:</strong> ${stats.activityStreak || 0}ì¼</p>
                            <p><strong>ë§ˆì§€ë§‰ í™œë™:</strong> ${stats.lastActiveDate ? new Date(stats.lastActiveDate).toLocaleString('ko-KR') : 'N/A'}</p>
                        </div>
                    </div>

                    <div class="result-card">
                        <h3 class="result-title">ì¹´í…Œê³ ë¦¬ ì„ í˜¸ë„</h3>
                        <div style="margin-top: 1rem;">
                            ${categories && categories.length > 0
                        ? categories.map(cat => `
                                    <div class="badge badge-primary">${cat.categoryName} (${cat.weight})</div>
                                `).join('')
                        : '<p class="text-muted">ì„¤ì •ëœ ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'
                    }
                        </div>
                    </div>

                    <div class="result-card">
                        <h3 class="result-title">ğŸ“… ì•„ì¹´ì´ë¸Œ íˆìŠ¤í† ë¦¬ (ìµœê·¼ 30ì¼)</h3>
                        <div id="archive-history-${userId}" style="margin-top: 1rem;">
                            ${renderArchiveHistory(archives)}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Failed to load user detail:', error);
                Toast.show('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                closeUserDetailModal();
            }
        }

        // Close user detail modal
        function closeUserDetailModal() {
            document.getElementById('user-detail-modal').classList.remove('active');
        }

        // Close modal on overlay click
        document.getElementById('user-detail-modal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeUserDetailModal();
            }
        });

        // Close modal on ESC key
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeUserDetailModal();
            }
        });

        // Render archive history
        function renderArchiveHistory(archives) {
            if (!archives || archives.length === 0) {
                return '<p class="text-muted">ì•„ì¹´ì´ë¸Œ íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            }

            // Create a calendar-like view
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Group by month for headers
            let html = '';
            let currentMonth = null;

            archives.forEach((archive, index) => {
                const date = new Date(archive.date);
                date.setHours(0, 0, 0, 0);

                const month = date.getMonth();
                const year = date.getFullYear();

                // Add month header when month changes
                if (currentMonth !== `${year}-${month}`) {
                    if (index > 0) {
                        html += '</div>'; // Close previous grid
                    }

                    currentMonth = `${year}-${month}`;
                    const monthName = date.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long' });

                    html += `<div style="margin-top: ${index > 0 ? '1.5rem' : '0'};">`;
                    html += `<div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary);">${monthName}</div>`;
                    html += '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem;">';
                }

                const hasArchive = archive.hasArchive;
                const contentCount = archive.contentCount || 0;
                const dayOfMonth = date.getDate();
                const isToday = date.getTime() === today.getTime();

                html += `
                    <div style="
                        padding: 0.5rem;
                        text-align: center;
                        border-radius: var(--radius-sm);
                        background: ${hasArchive ? 'var(--color-success)' : 'var(--bg-overlay)'};
                        color: ${hasArchive ? 'var(--bg-primary)' : 'var(--text-secondary)'};
                        font-weight: ${isToday ? '700' : '400'};
                        border: ${isToday ? '2px solid var(--color-primary)' : 'none'};
                        font-size: 0.85rem;
                    " title="${archive.date}${hasArchive ? ` - ${contentCount}ê°œ ì½˜í…ì¸ ` : ' - ì•„ì¹´ì´ë¸Œ ì—†ìŒ'}">
                        ${dayOfMonth}
                    </div>
                `;
            });

            html += '</div></div>'; // Close last grid and container

            html += '<div style="margin-top: 1rem; display: flex; gap: 1rem; font-size: 0.85rem;">';
            html += '<div><span style="display: inline-block; width: 12px; height: 12px; background: var(--color-success); border-radius: 2px; margin-right: 0.5rem;"></span>ì•„ì¹´ì´ë¸Œ ìˆìŒ</div>';
            html += '<div><span style="display: inline-block; width: 12px; height: 12px; background: var(--bg-overlay); border-radius: 2px; margin-right: 0.5rem;"></span>ì•„ì¹´ì´ë¸Œ ì—†ìŒ</div>';
            html += '</div>';

            return html;
        }
    </script>
</body>

</html>